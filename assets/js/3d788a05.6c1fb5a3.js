"use strict";(self.webpackChunkpiwik_pro=self.webpackChunkpiwik_pro||[]).push([[6975],{28546:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>r,default:()=>h,frontMatter:()=>c,metadata:()=>o,toc:()=>d});var s=t(85893),i=t(11151);const c={},r="Introduction",o={id:"other/content-security-policy",title:"content-security-policy",description:"Content Security Policy (CSP) ==============",source:"@site/docs/other/content-security-policy.md",sourceDirName:"other",slug:"/other/content-security-policy",permalink:"/docs/other/content-security-policy",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/other/content-security-policy.md",tags:[],version:"current",frontMatter:{},sidebar:"otherSideBar",next:{title:"custom-popup-examples",permalink:"/docs/other/custom-popup-examples"}},a={},d=[];function l(e){const n={a:"a",code:"code",h1:"h1",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"Content Security Policy (CSP) =============="}),"\n",(0,s.jsx)(n.h1,{id:"introduction",children:"Introduction"}),"\n",(0,s.jsxs)(n.p,{children:["Specifying Content Security Policy is a common way to secure web\napplications. This mechanism allows specifying which scripts and styles\ncan execute on page. It can be done either by adding a\n",(0,s.jsx)(n.code,{children:"Content-Security-Policy"})," header or an appropriate meta tag."]}),"\n",(0,s.jsxs)(n.p,{children:["You can read about Consent Security Policy here:\n",(0,s.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP",children:"https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP"})]}),"\n",(0,s.jsx)(n.p,{children:"Content Security Policy nonce configuration ---------------It is common\nto allow only scripts and styles that were received from known domains\nor ones that have special nonce attribute. Nonce mechanism relies on two\nsteps, defining nonce value in Content Security Policy and placing nonce\nvalue as an attribute in styles and scripts."}),"\n",(0,s.jsxs)(n.p,{children:["Defining nonce in Content Security Policy settings\n",(0,s.jsx)(n.code,{children:" ``  ``  ``  ``  ``  ``  ``  ```"})," Nonce mechanism requires additional\ndefinition in ",(0,s.jsx)(n.code,{children:"script-src`directive of Content Security Policy: .. code-block:: javascript script-src <your-sources> 'nonce-INSERT_VALID_NONCE_VALUE'; .. note:: **Note:** Nonce value should be generated on the server-side. Its value should be different for each request. Please note that we leave here space for your permitted sources`\\<your-sources\\>`. Add nonce to container code"}),"  ",(0,s.jsx)(n.code,{children:"  "}),"  ",(0,s.jsx)(n.code,{children:"  "}),"  ",(0,s.jsx)(n.code,{children:"  "}),"  ``  ",(0,s.jsx)(n.code,{children:"\\"})," Consequently, default container\ncode requires following modifications to work:"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Asynchronous snippet:"})," In this container code the following changes\n(highlighted) are required:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-html",children:'<script type="text/javascript" nonce="INSERT_VALID_NONCE_VALUE">\n    (function(window, document, dataLayerName, id) {\n    window[dataLayerName]=window[dataLayerName]||[],window[dataLayerName].push({start:(new Date).getTime(),event:"stg.start"});\n    var scripts=document.getElementsByTagName(\'script\')[0],tags=document.createElement(\'script\');\n    function stgCreateCookie(a,b,c){var d="";if(c){var e=new Date;e.setTime(e.getTime()+24*c*60*60*1e3),d=";expires="+e.toUTCString()}document.cookie=a+"="+b+d+"; path=/"}\n    var isStgDebug=(window.location.href.match("stg_debug")||document.cookie.match("stg_debug"))&&!window.location.href.match("stg_disable_debug");\n    stgCreateCookie("stg_debug",isStgDebug?1:"",isStgDebug?14:-1);\n    var qP=[];dataLayerName!=="dataLayer"&&qP.push("data_layer_name="+dataLayerName),isStgDebug&&qP.push("stg_debug");\n    var qPString=qP.length>0?("?"+qP.join("&")):"";\n    tags.async=!0,tags.src="//client.containers.piwik.pro/"+id+".js"+qPString,\n    scripts.parentNode.insertBefore(tags,scripts);\n    !function(a,n,i){a[n]=a[n]||{};for(var c=0;c<i.length;c++)!function(i){a[n][i]=a[n][i]||{},a[n][i].api=a[n][i].api||function(){\n    var a=[].slice.call(arguments,0);"string"==typeof a[0]&&window[dataLayerName].push({event:n+"."+i+":"+a[0],parameters:[].slice.call(arguments,1)})}}(i[c])}(window,"ppms",["tm","cm"]);\n    })(window, document, \'dataLayer\', \'feacd61d-0232-40a1-96c3-7e469f7bfa7f\');\n<\/script>\n<noscript>\n    <iframe src="//client.containers.piwik.pro/feacd61d-0232-40a1-96c3-7e469f7bfa7f/noscript.html" height="0" width="0" style="display:none;visibility:hidden"></iframe>\n</noscript>\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Synchronous snippet:"})," In this container code the following changes\n(highlighted) are required:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-html",children:'<script type="text/javascript" nonce="INSERT_VALID_NONCE_VALUE">\n    (function(window, document, dataLayerName, id) {\n    function stgCreateCookie(a,b,c){var d="";if(c){var e=new Date;e.setTime(e.getTime()+24*c*60*60*1e3),d=";expires="+e.toUTCString()}document.cookie=a+"="+b+d+"; path=/"}\n    var isStgDebug=(window.location.href.match("stg_debug")||document.cookie.match("stg_debug"))&&!window.location.href.match("stg_disable_debug");\n    stgCreateCookie("stg_debug",isStgDebug?1:"",isStgDebug?14:-1);\n    var qP=[];dataLayerName!=="dataLayer"&&qP.push("data_layer_name="+dataLayerName),isStgDebug&&qP.push("stg_debug");\n    var qPString=qP.length>0?("?"+qP.join("&")):"";\n    document.write(\'<script src="//client.containers.piwik.pro/\'+id+\'.sync.js\' + qPString + \'" nonce="INSERT_VALID_NONCE_VALUE"></\' + \'script>\');\n    })(window, document, \'dataLayer\', \'feacd61d-0232-40a1-96c3-7e469f7bfa7f\');\n<\/script>\n'})}),"\n",(0,s.jsxs)("div",{class:"note",children:[(0,s.jsx)("div",{class:"title",children:(0,s.jsx)(n.p,{children:"Note"})}),(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Note:"})," All that is needed for Tag Manager to work is to replace\n",(0,s.jsx)(n.code,{children:"INSERT_VALID_NONCE_VALUE"})," with generated nonce value. It should be done\ntwice for both asynchronous and synchronous snippet."]})]}),"\n",(0,s.jsx)(n.p,{children:"Adjust tags to work with Content Security Policy ---------------"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Asynchronous tags"}),": in most cases there should not be any change\nrequired to make asynchronous tags work. Tag Manager will automatically\ninsert nonce attribute to all fired tags. Only exceptions is when Your\ntag adds other scripts/styles on page by itself - in such case, You\nshould add nonce attribute manually."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Synchronous tags"}),": since synchronous tags have to fire before whole\npage is loaded, following procedure is recommended."]}),"\n",(0,s.jsx)(n.p,{children:"This procedure is recommended:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Create new variable with value of nonce parameter. It is not\nrequired to create nonce variable in admin panel. Just pushing it on\ndataLayer before script is executed is enough."}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"window.dataLayer.push({\nnonce: INSERT_VALID_NONCE_VALUE\n});\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsx)(n.li,{children:"Use created variable as value for nonce attribute like follows:"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-html",children:'<script nonce="{{ nonce }}">\n  console.log("I\'m synchronous tag!");\n  document.write(\'<p id="synchronous-tag">I was inserted by synchronous tag</p>\');\n<\/script>\n'})}),"\n",(0,s.jsxs)("div",{class:"note",children:[(0,s.jsx)("div",{class:"title",children:(0,s.jsx)(n.p,{children:"Note"})}),(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Note:"})," Finally, not all 3rd party tools that are available as\nbuilt-in templates are adjusted to work with Content Security Policy.\nThis includes e.g. Google Analytics. In such cases, please refer to\ndocumentation of each respective tool (e.g.\n",(0,s.jsx)(n.a,{href:"https://developers.google.com/web/fundamentals/security/csp",children:"https://developers.google.com/web/fundamentals/security/csp"}),")."]})]}),"\n",(0,s.jsx)(n.p,{children:"Tag Manager debugger --------------"}),"\n",(0,s.jsxs)(n.p,{children:["To load all necessary assets from Tag Manager debugger you need to\ndefine source with ",(0,s.jsx)(n.code,{children:"img-src"}),", ",(0,s.jsx)(n.code,{children:"font-src"})," and ",(0,s.jsx)(n.code,{children:"style-src"})," directives:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"img-src <your-sources> client.containers.piwik.pro;\nfont-src <your-sources> client.containers.piwik.pro;\nstyle-src <your-sources> client.containers.piwik.pro;\n"})}),"\n",(0,s.jsx)(n.p,{children:"Consent Manager form assets ------------"}),"\n",(0,s.jsxs)(n.p,{children:["If your website is GDPR compliant then you need to describe\n",(0,s.jsx)(n.code,{children:"connect-src"}),", ",(0,s.jsx)(n.code,{children:"style-src"})," and ",(0,s.jsx)(n.code,{children:"img-src"})," directives:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"connect-src <your-sources> client.piwik.pro client.containers.piwik.pro;\nstyle-src <your-sources> 'nonce-INSERT_VALID_NONCE_VALUE';\n"})}),"\n",(0,s.jsxs)("div",{class:"note",children:[(0,s.jsx)("div",{class:"title",children:(0,s.jsx)(n.p,{children:"Note"})}),(0,s.jsxs)(n.p,{children:["Please note that we define here tracking domain ",(0,s.jsx)(n.strong,{children:"client.piwik.pro"})," for\ncollecting visitor consents and container domain\n",(0,s.jsx)(n.strong,{children:"client.containers.piwik.pro"})," for fetching consent form assets."]})]}),"\n",(0,s.jsx)(n.p,{children:"Consent Manager's data subject request widget ------------"}),"\n",(0,s.jsxs)(n.p,{children:["When using a data subject request widget, you need to add a nonce\nattribute to its ",(0,s.jsx)(n.code,{children:"<script>"})," tag."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-html",children:'<div id="ppms_cm_data_subject" class="ppms_cm_data_subject_widget__wrapper" data-editor-centralize="true" data-main-container="true" data-root="true">\n    <h3 id="ppms_cm_data_subject_header" class="header3">Data requests</h3>\n    <p id="ppms_cm_data_subject_paragraph" class="paragraph">\n        Please select below the type of data request along with any special requests in the body of the message. (...)\n    </p>\n    <form id="ppms_cm_data_subject_form" class="ppms_cm_data_subject_form" data-disable-select="true">\n        ...\n    </form>\n    <script nonce="INSERT_VALID_NONCE_VALUE">\n        ...\n    <\/script>\n</div>\n'})}),"\n",(0,s.jsx)(n.h1,{id:"tracking-with-custom-domain",children:"Tracking with custom domain"}),"\n",(0,s.jsxs)(n.p,{children:["If your tracking domain is custom, then you need to define it with\n",(0,s.jsx)(n.code,{children:"img-src"})," and ",(0,s.jsx)(n.code,{children:"script-src"})," directives:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"img-src <your-sources> your-custom-cpp-domain.com;\nscript-src <your-sources> your-custom-cpp-domain.com;\n"})}),"\n",(0,s.jsx)(n.p,{children:"Example Content Security Policy definition ------------"}),"\n",(0,s.jsx)(n.p,{children:"Following example configuration of CSP assumes:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Client's website address: ",(0,s.jsx)(n.strong,{children:"client.com"})]}),"\n",(0,s.jsx)(n.li,{children:"Consent Manager is enabled for the website"}),"\n",(0,s.jsxs)(n.li,{children:["Client's organization name in Piwik PRO: ",(0,s.jsx)(n.strong,{children:"client"})]}),"\n",(0,s.jsxs)(n.li,{children:["Client's container domain: ",(0,s.jsx)(n.strong,{children:"client.containers.piwik.pro"})]}),"\n",(0,s.jsxs)(n.li,{children:["Client has Piwik PRO tag with default tracking domain:\n",(0,s.jsx)(n.strong,{children:"client.piwik.pro"})]}),"\n",(0,s.jsxs)(n.li,{children:["Nonce value: ",(0,s.jsx)(n.strong,{children:"nceIOfn39fn3e9h3sd"})]}),"\n",(0,s.jsxs)(n.li,{children:["Configuration allows ",(0,s.jsx)(n.code,{children:"'self'"})," source which is: ",(0,s.jsx)(n.strong,{children:"client.com"})]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"Content-Security-Policy: default-src 'self';\n                         script-src  'self' client.piwik.pro 'nonce-nceIOfn39fn3e9h3sd';\n                         connect-src 'self' client.containers.piwik.pro client.piwik.pro;\n                         img-src     'self' client.containers.piwik.pro client.piwik.pro;\n                         font-src    'self' client.containers.piwik.pro;\n                         style-src   'self' client.containers.piwik.pro 'nonce-nceIOfn39fn3e9h3sd';\n"})})]})}function h(e={}){const{wrapper:n}={...(0,i.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},11151:(e,n,t)=>{t.d(n,{Z:()=>o,a:()=>r});var s=t(67294);const i={},c=s.createContext(i);function r(e){const n=s.useContext(c);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(c.Provider,{value:n},e.children)}}}]);